import fs from 'fs'
import { generateObject } from 'ai'
import { getOpenModel } from './agentUtils.js'
import { z } from 'zod'



const systemPrompt = `# ROLE AND CONTEXT
You are an knowledge and information specialist: your job is to redact, summarise, and separate different pieces of information from a report.

Your are working in a scientific project, that aims to back-test AI forecasting agents.

The ultimate  objective is to generate a data set that can be used to back-test AI forecasting agents under different information conditions. A key coponent of the analysis will be to test the effect of different information units on the performance of the agent. 

More specifically, three AI forecasting agents will work together to generate a forecast for the question. Each forecasting agent will posess a different, unique piece of information that is relevant to the question, that the other two agents do not have. The aim is to test the effect of deliberation and information exchange on the performance of the agents as a group.

Your job is to prepare these information packages for the agents: 3 units of non-overlapping accurate information.


# INPUT DATA

You are given: 
 a) a forecasting question 
 c) one or more reports that were generated by AI agents *BEFORE* the outcome of the question was determined.

The reports may contain information on:
    - the original question, resolution criteria, and background information
    - information that was available to the agent without external search
    - information that the agent received from external search (e.g. summaries of news reports, general information about entities, etc.)
    - the agent's internal reasoning and critique of the information it received
    - the agent's final forecast and rationale
    - other information that was not relevant to the question or the resolution


# TASK    

Your task is to extract and summarise information that fulfils the following criteria:

    1) the information was retrieved by the agent from external sources
    2) the information is relevant with respect to the question 
    3) the information does not contain any subjective judgements or opinions
    4) the information does not contain any probabilistic forecasts or predictions

Split the information into 3 units, each of which should be a separate piece of information. 


##  GUIDELINES:

- Summarise the information that seems most important and relevant to the question. 
- Your summary should split the information into 3 units, each of which should be a separate piece of information. 
- Split the information in a sensible, natural way (e.g. by type of information or by sources of information).
- Do not try to deliberately split information with respect to whether they make the outcome more or less likely. Occasionally, this may happen naturally, but do not force it.


# FINAL CHECKS

1) You have extracted and summarised the information from the report and split it into 3 units, each of which should be a separate piece of information.
2) No information unit should contain more than 1000 words.
3) the infromation units only include facts, background information, and other information that is relevant to the question.
4) the information does not include:
    - NO subjective judgements or opinions
    - NO probabilistic forecasts or predictions
    - NO reasoning or critique of the information
    - NO rationales or estimates


# OUTPUT

The output should be a JSON object with the following structure:
{
    "information_units": [
        "information unit 1",
        "information unit 2",
        "information unit 3",
    ]
}
    
Notes: be clear and concise. Focus on factual information, statements, news reports, etc. Do not include any reasoning or critique of the information. Do not include information generally known to the public. Do not start the information units with 'Information unit 1:' or any other such prefix.`


const informationProcessor = async (report = {}) => {

    const {questionTitle, questionDescription, questionResolutionCriteria, questionFinePrint, comments} = report


    const userPrompt = `# Original Forecasting Question:

<|question|>${questionTitle}</|question|>

The following background information was provided together with the question:
<|background_info|>
Description: ${questionDescription}
Resolution criteria: ${questionResolutionCriteria}
Fine print: ${questionFinePrint}
</|background_info|>

# Agents' Reports:

The following reports were generated by AI agents before the outcome of the question was determined and submitted to Metaculus:

<|agents_reports|>
${comments}
</|agents_reports|>


# Task:
Please extract and summarise the information from the agents' reports and split it into 3 units, each of which should be a separate piece of information. Be extremely thorough, conscientious, and think hard.`

    const MODEL = 'pro'
    const result = await generateObject({
        model: getOpenModel(MODEL),
        schema: z.object({
            information_units: z.array(z.string()),
        }),
        system: systemPrompt,
        messages: [{
            role: 'user',
            content: userPrompt
        }],
        providerOptions: {
            google: {
              thinkingConfig: {
                thinkingBudget: 2_500,
              },
            },
        },
        maxOutputTokens: 10_000
    })
    return result.object
}



const questionsRaw = JSON.parse(fs.readFileSync('data/raw/questions.json', 'utf8'));

fs.mkdirSync('data/processed', { recursive: true });

let questions = []
if (fs.existsSync('data/processed/questions.json')) {
    // can re-run to fix errors of previous runs
    questions = JSON.parse(fs.readFileSync('data/processed/questions.json', 'utf8'))
}
let i = 0;
let errors = 0;
let total = questionsRaw.length;
for (const qRaw of questionsRaw) {

    // has it already been processed and saved?
    i++;
    if (questions.find(q => q.id === qRaw.id)) {
        process.stdout.write(`\rQuestion ${i}/${total} already processed and saved.`);
        continue
    }

    process.stdout.write(`\rProcessing question ${i}/${total}...`);

    let question = {
        ...qRaw,
        comments: undefined,
        informationPackages: [],
    }

    let pkg = null;
    try {
        pkg = await informationProcessor(qRaw)

        if (!pkg || !pkg.information_units || pkg.information_units.length !== 3) {
            throw new Error(`Invalid information packages for question ${qRaw.id}`)
        }
        question.informationPackages = pkg.information_units;
        questions.push(question)
    } catch (error) {
        errors++;
        console.error(`Error processing question ${qRaw.id}: ${error}`)
    }
}

console.log(`Errors: ${errors}`)
fs.writeFileSync('data/processed/questions.json', JSON.stringify(questions, null, 2))